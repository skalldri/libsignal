name: "Release - React Native"
run-name: ${{ github.workflow }} (${{ github.ref_name }})

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Build only, don't create a GitHub release"
        default: true
        required: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  NDK_VERSION: 27.1.12297006

jobs:
  build-rust:
    name: Build libsignal_ffi (${{ matrix.target }})

    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - target: aarch64-linux-android
            abi: arm64-v8a
          - target: armv7-linux-androideabi
            abi: armeabi-v7a
          - target: x86_64-linux-android
            abi: x86_64
          - target: i686-linux-android
            abi: x86

    timeout-minutes: 90

    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        submodules: recursive

    - run: 'echo "JAVA_HOME=$JAVA_HOME_17_X64" >> "$GITHUB_ENV"'

    - name: Install Rust toolchain
      run: rustup toolchain install "$(cat rust-toolchain)" --profile minimal --target ${{ matrix.target }}

    - name: Install cargo-ndk
      run: cargo install cargo-ndk --locked

    - name: Install Android NDK
      run: |
        "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --install "ndk;${NDK_VERSION}"
        echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}" >> "$GITHUB_ENV"

    - name: Install protoc
      run: |
        curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v32.0/protoc-32.0-linux-x86_64.zip
        sudo unzip -o protoc-32.0-linux-x86_64.zip -d /usr/local bin/protoc
        sudo unzip -o protoc-32.0-linux-x86_64.zip -d /usr/local 'include/*'
        rm protoc-32.0-linux-x86_64.zip

    - name: Build libsignal_ffi.so (release, stripped)
      run: |
        cd react-native
        bash scripts/build_android.sh --release --strip --abi ${{ matrix.abi }}

    - name: Upload native library
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: libsignal_ffi-${{ matrix.abi }}
        path: react-native/android/jniLibs/${{ matrix.abi }}/libsignal_ffi.so
        retention-days: 7

  build-rust-ios:
    name: Build libsignal_ffi iOS (${{ matrix.target }})

    runs-on: macos-latest

    strategy:
      matrix:
        include:
          - target: aarch64-apple-ios
            platform: ios-device
          - target: aarch64-apple-ios-sim
            platform: ios-sim-arm64
          - target: x86_64-apple-ios
            platform: ios-sim-x86_64

    timeout-minutes: 120

    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        submodules: recursive

    - name: Install Rust toolchain
      run: rustup toolchain install "$(cat rust-toolchain)" --profile minimal --target ${{ matrix.target }}

    - name: Install protoc
      run: brew install protobuf

    - name: Build libsignal_ffi.a (release)
      env:
        IPHONEOS_DEPLOYMENT_TARGET: "15"
      run: |
        FEATURES_ARG=""
        if [[ "${{ matrix.target }}" != "aarch64-apple-ios" ]]; then
          FEATURES_ARG="--features libsignal-bridge-testing"
        fi
        CARGO_BUILD_TARGET="${{ matrix.target }}" \
        RUSTFLAGS="--cfg aes_armv8 --cfg tokio_unstable" \
        cargo build --release \
          --manifest-path rust/bridge/ffi/Cargo.toml \
          --target ${{ matrix.target }} \
          ${FEATURES_ARG} \
          --lib

    - name: Upload native library
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: libsignal_ffi-${{ matrix.platform }}
        path: target/${{ matrix.target }}/release/libsignal_ffi.a
        retention-days: 7

  package:
    name: Package release zip

    runs-on: macos-latest

    needs: [build-rust, build-rust-ios]

    timeout-minutes: 15

    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        submodules: recursive

    - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: 22

    - name: Download Android native libraries
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        path: react-native/android/jniLibs
        pattern: libsignal_ffi-arm*
        merge-multiple: false

    - name: Download Android x86 libraries
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        path: react-native/android/jniLibs
        pattern: libsignal_ffi-x86*
        merge-multiple: false

    - name: Download iOS libraries
      uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
      with:
        path: react-native/ios-artifacts
        pattern: libsignal_ffi-ios-*
        merge-multiple: false

    - name: Arrange jniLibs into ABI directories
      run: |
        cd react-native/android/jniLibs
        for dir in libsignal_ffi-*; do
          abi="${dir#libsignal_ffi-}"
          mkdir -p "${abi}"
          mv "${dir}/libsignal_ffi.so" "${abi}/libsignal_ffi.so"
          rmdir "${dir}"
        done
        echo "=== jniLibs contents ==="
        find . -type f -exec ls -lh {} \;

    - name: Assemble iOS XCFramework
      run: |
        cd react-native
        mkdir -p ios

        # Copy device library
        cp ios-artifacts/libsignal_ffi-ios-device/libsignal_ffi.a ios/libsignal_ffi.a

        # Create fat simulator library from arm64 + x86_64
        mkdir -p ios/.sim_staging
        lipo -create \
          ios-artifacts/libsignal_ffi-ios-sim-arm64/libsignal_ffi.a \
          ios-artifacts/libsignal_ffi-ios-sim-x86_64/libsignal_ffi.a \
          -output ios/.sim_staging/libsignal_ffi.a

        # Create header directories
        mkdir -p ios/.headers_device ios/.headers_sim
        cp ../swift/Sources/SignalFfi/signal_ffi.h ios/.headers_device/
        cp ../swift/Sources/SignalFfi/signal_ffi.h ios/.headers_sim/

        # Build XCFramework
        xcodebuild -create-xcframework \
          -library ios/libsignal_ffi.a -headers ios/.headers_device \
          -library ios/.sim_staging/libsignal_ffi.a -headers ios/.headers_sim \
          -output ios/libsignal_ffi.xcframework

        rm -rf ios/.sim_staging ios/.headers_device ios/.headers_sim ios-artifacts

        echo "=== iOS XCFramework ==="
        find ios/libsignal_ffi.xcframework -type f -exec ls -lh {} \;

    - name: Generate C++ headers
      run: |
        cd react-native
        cp ../swift/Sources/SignalFfi/signal_ffi.h cpp/signal_ffi.h
        python3 scripts/patch_header_cpp.py cpp/signal_ffi.h cpp/signal_ffi_cpp.h

    - name: Install npm dependencies and compile TypeScript
      run: |
        cd react-native
        npm install
        npx tsc

    - name: Assemble release zip
      run: |
        VERSION="${GITHUB_REF_NAME:-dev}"
        STAGING="react-native-libsignal-${VERSION}"
        mkdir -p "${STAGING}"

        # Copy package metadata
        cp react-native/package.json "${STAGING}/"
        cp react-native/tsconfig.json "${STAGING}/"
        cp react-native/README.md "${STAGING}/"
        cp react-native/docs/INTEGRATION.md "${STAGING}/"

        # Compiled TypeScript (JS + declarations)
        cp -r react-native/lib "${STAGING}/lib"

        # TypeScript source (for source maps / reference)
        cp -r react-native/ts "${STAGING}/ts"

        # C++ native module source + generated headers
        mkdir -p "${STAGING}/cpp"
        cp react-native/cpp/*.h "${STAGING}/cpp/"
        cp react-native/cpp/*.cpp "${STAGING}/cpp/"

        # Android library (Gradle, CMake, Java, jniLibs with all ABIs)
        cp -r react-native/android "${STAGING}/android"
        # Remove build artifacts that shouldn't be shipped
        rm -rf "${STAGING}/android/build" \
               "${STAGING}/android/.cxx" \
               "${STAGING}/android/.gradle"

        # iOS library (XCFramework, Obj-C++ installer, podspec)
        mkdir -p "${STAGING}/ios"
        cp -r react-native/ios/libsignal_ffi.xcframework "${STAGING}/ios/"
        cp react-native/ios/LibsignalInstaller.mm "${STAGING}/ios/"
        cp react-native/react-native-libsignal.podspec "${STAGING}/"

        # Scripts (for rebuilding from source if needed)
        cp -r react-native/scripts "${STAGING}/scripts"

        echo "=== Release contents ==="
        find "${STAGING}" -type f | head -80
        echo "..."
        echo ""
        echo "=== Native library sizes ==="
        find "${STAGING}" -name "*.so" -exec ls -lh {} \;
        find "${STAGING}" -name "*.a" -exec ls -lh {} \;
        echo ""

        # Create zip
        zip -r "react-native-libsignal-${VERSION}.zip" "${STAGING}/"

        echo "=== Final zip ==="
        ls -lh "react-native-libsignal-${VERSION}.zip"
        echo "ZIP_NAME=react-native-libsignal-${VERSION}.zip" >> "$GITHUB_ENV"
        echo "ZIP_PATH=react-native-libsignal-${VERSION}.zip" >> "$GITHUB_ENV"

    - name: Upload release zip
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: react-native-libsignal-release
        path: ${{ env.ZIP_PATH }}
        retention-days: 30

    - name: Create GitHub Release
      if: ${{ !inputs.dry_run && github.ref_type == 'tag' }}
      uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
      with:
        files: ${{ env.ZIP_PATH }}
        generate_release_notes: true
